<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEGA FALL</title>
    <!-- Добавляем SDK Telegram для работы в Mini Apps -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 0 8px #333, 0 0 0 12px #111;
            image-rendering: pixelated;
        }

        canvas {
            display: block;
            background: #4ec0ca; 
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            pointer-events: none;
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #fff;
            text-shadow: 2px 2px #000;
            z-index: 5;
        }

        .controls-ui {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            pointer-events: auto;
            z-index: 20;
        }

        .mute-btn {
            background: #222034;
            border: 2px solid #fff;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 7px;
            padding: 6px;
            cursor: pointer;
            pointer-events: auto;
        }
        .mute-btn.active {
            background: #f00;
            border-color: #f00;
        }

        #start-screen, #game-over-screen, #skin-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: #222034;
            padding: 20px;
            border: 4px solid #fff;
            box-shadow: 4px 4px 0 #5f574f;
            width: 85%;
            z-index: 10;
            box-sizing: border-box;
        }

        h1 { font-size: 14px; margin-bottom: 20px; color: #fbf236; line-height: 1.4; }
        p { font-size: 8px; line-height: 1.8; margin: 10px 0; color: #cbdbfc; }

        .btn-group { display: flex; flex-direction: column; gap: 10px; }

        button {
            background: #37946e;
            border: none;
            border-bottom: 4px solid #225af6;
            padding: 10px 15px;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            color: #fff;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        button:active { border-bottom: none; transform: translateY(4px); }
        button.alt { background: #5f574f; border-bottom-color: #323c39; }

        .skin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .skin-item {
            border: 2px solid #5f574f;
            padding: 10px 5px;
            cursor: pointer;
            background: #323c39;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .skin-item.selected { border-color: #fbf236; background: #37946e; }
        .skin-item.locked { opacity: 0.5; cursor: not-allowed; }

        .skin-name { font-size: 6px; margin-bottom: 5px; color: #fff; text-transform: uppercase; }
        .skin-req { font-size: 5px; color: #fbf236; margin-top: 4px; }

        .hidden { display: none !important; }
        
        #highScoreLabel { font-size: 8px; color: #fbf236; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="320" height="448"></canvas>
    
    <div id="ui-layer">
        <div>SCORE:<span id="scoreVal">000000</span></div>
        <div>WORLD:<span id="levelVal">1-1</span></div>
    </div>

    <!-- Кнопки управления звуком -->
    <div class="controls-ui">
        <button id="muteSfxBtn" class="mute-btn">SFX:ON</button>
        <button id="muteMusicBtn" class="mute-btn">BGM:ON</button>
    </div>

    <div id="start-screen">
        <h1>MEGA FALL</h1>
        <div id="highScoreLabel">BEST: 0</div>
        <div class="btn-group">
            <button id="startBtn">START GAME</button>
            <button id="openSkinsBtn" class="alt">SKINS</button>
        </div>
    </div>

    <div id="skin-screen" class="hidden">
        <h1>SELECT SKIN</h1>
        <div class="skin-grid" id="skinGrid"></div>
        <button id="closeSkinsBtn" style="margin-top: 15px; width: 100%;">BACK</button>
    </div>

    <div id="game-over-screen" class="hidden">
        <h1>GAME OVER</h1>
        <p>SCORE: <span id="finalScore">0</span></p>
        <div class="btn-group">
            <button id="restartBtn">TRY AGAIN</button>
            <button id="overSkinsBtn" class="alt">SKINS</button>
        </div>
    </div>
</div>

<script>
/**
 * НАСТРОЙКИ МУЗЫКИ
 */
const MENU_MUSIC_URL = "https://github.com/DinSoprano/Game1/raw/refs/heads/main/audio/Main%20menu.mp3"; 
const GAME_MUSIC_URL = "https://github.com/DinSoprano/Game1/raw/refs/heads/main/audio/Level.mp3"; 

/**
 * ДАННЫЕ СКИНОВ
 */
const SKINS = [
    { id: 'classic', name: 'RED CLASSIC', color: '#f00', eye: '#fff', req: 0 },
    { id: 'speedster', name: 'BLUE SPEED', color: '#30a0ff', eye: '#fff', req: 2000 },
    { id: 'gold', name: 'GOLDEN', color: '#fbf236', eye: '#000', req: 10000 },
    { id: 'void', name: 'VOID', color: '#111', eye: '#f00', req: 25000 }
];

/**
 * СИСТЕМА ЗВУКА
 */
class SoundManager {
    constructor() { 
        this.ctx = null;
        this.menuMusic = new Audio(MENU_MUSIC_URL);
        this.gameMusic = new Audio(GAME_MUSIC_URL);
        this.menuMusic.loop = true;
        this.gameMusic.loop = true;
        
        this.sfxMuted = false;
        this.musicMuted = false;
        this.currentMusicType = null;
    }
    
    init() {
        if (this.ctx) return;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    }

    toggleSfx() {
        this.sfxMuted = !this.sfxMuted;
        return this.sfxMuted;
    }

    toggleMusic() {
        this.musicMuted = !this.musicMuted;
        if (this.musicMuted) {
            this.menuMusic.pause();
            this.gameMusic.pause();
        } else {
            if (this.currentMusicType) this.playMusic(this.currentMusicType);
        }
        return this.musicMuted;
    }

    playMusic(type) {
        this.currentMusicType = type;
        this.menuMusic.pause();
        this.gameMusic.pause();

        if (this.musicMuted) return;

        if (type === 'menu' && MENU_MUSIC_URL) {
            this.menuMusic.currentTime = 0;
            this.menuMusic.play().catch(e => console.log("Music blocked"));
        } else if (type === 'game' && GAME_MUSIC_URL) {
            this.gameMusic.currentTime = 0;
            this.gameMusic.play().catch(e => console.log("Music blocked"));
        }
    }

    stopAllMusic() {
        this.menuMusic.pause();
        this.gameMusic.pause();
    }

    play(freq, type, dur, slide) {
        if (!this.ctx || this.sfxMuted) return;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        if (slide) osc.frequency.exponentialRampToValueAtTime(slide, this.ctx.currentTime + dur);
        g.gain.setValueAtTime(0.05, this.ctx.currentTime);
        g.gain.linearRampToValueAtTime(0, this.ctx.currentTime + dur);
        osc.connect(g); g.connect(this.ctx.destination);
        osc.start(); osc.stop(this.ctx.currentTime + dur);
    }
    jump() { this.play(150, 'square', 0.1, 400); }
    land() { 
        this.play(100, 'triangle', 0.1, 50); 
        // Тактильная отдача для Telegram
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
    }
    bonus() { this.play(880, 'sine', 0.05, 1200); }
    die() { 
        this.play(300, 'sawtooth', 0.4, 20); 
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        }
    }
}

/**
 * ИГРОВОЙ ДВИЖОК
 */
const GRAVITY = 0.22;
const MAX_VX = 5;

const PLATFORM_TYPES = {
    NORMAL: 'normal',
    VANISHING: 'vanishing',
    BONUS: 'bonus'
};

const LEVELS = [
    { threshold: 0, sky: '#4ec0ca', plat: '#8b4513', grass: '#32cd32', speed: 0.8 },
    { threshold: 5000, sky: '#2e4482', plat: '#555', grass: '#999', speed: 1.1 },
    { threshold: 12000, sky: '#4a1a1a', plat: '#222', grass: '#f00', speed: 1.5 }
];

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.ctx.imageSmoothingEnabled = false;
        this.input = { left: false, right: false };
        this.audio = new SoundManager();
        
        this.highScore = 0;
        this.selectedSkin = SKINS[0];

        // Управление клавиатурой
        window.addEventListener('keydown', (e) => this.key(e, true));
        window.addEventListener('keyup', (e) => this.key(e, false));

        // Управление касанием (для мобильных)
        this.canvas.addEventListener('touchstart', (e) => {
            const touchX = e.touches[0].clientX;
            if (touchX < window.innerWidth / 2) this.input.left = true;
            else this.input.right = true;
            e.preventDefault();
        }, {passive: false});

        this.canvas.addEventListener('touchend', (e) => {
            this.input.left = false;
            this.input.right = false;
            e.preventDefault();
        }, {passive: false});

        // Инициализация кнопок звука
        const sfxBtn = document.getElementById('muteSfxBtn');
        const bgmBtn = document.getElementById('muteMusicBtn');

        sfxBtn.onclick = () => {
            const isMuted = this.audio.toggleSfx();
            sfxBtn.innerText = isMuted ? "SFX:OFF" : "SFX:ON";
            sfxBtn.classList.toggle('active', isMuted);
        };

        bgmBtn.onclick = () => {
            const isMuted = this.audio.toggleMusic();
            bgmBtn.innerText = isMuted ? "BGM:OFF" : "BGM:ON";
            bgmBtn.classList.toggle('active', isMuted);
        };

        document.getElementById('startBtn').onclick = () => { 
            this.audio.init(); 
            this.start(); 
        };
        document.getElementById('restartBtn').onclick = () => this.start();
        
        document.getElementById('openSkinsBtn').onclick = () => {
            this.audio.init();
            this.audio.playMusic('menu');
            this.showSkins();
        };
        document.getElementById('overSkinsBtn').onclick = () => this.showSkins();
        document.getElementById('closeSkinsBtn').onclick = () => {
            document.getElementById('skin-screen').classList.add('hidden');
            if (this.state === 'GAMEOVER') document.getElementById('game-over-screen').classList.remove('hidden');
            else document.getElementById('start-screen').classList.remove('hidden');
        };

        this.reset();
        this.initParallax();
        this.renderSkinMenu();
        this.loop();
    }

    key(e, s) {
        if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') this.input.left = s;
        if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') this.input.right = s;
    }

    showSkins() {
        this.renderSkinMenu();
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('skin-screen').classList.remove('hidden');
    }

    renderSkinMenu() {
        const grid = document.getElementById('skinGrid');
        grid.innerHTML = '';
        SKINS.forEach(skin => {
            const isLocked = this.highScore < skin.req;
            const item = document.createElement('div');
            item.className = `skin-item ${this.selectedSkin.id === skin.id ? 'selected' : ''} ${isLocked ? 'locked' : ''}`;
            
            const preview = `<div style="width:20px; height:20px; background:${skin.color}; border:2px solid #000; margin-bottom:8px;"></div>`;
            const nameLabel = `<div class="skin-name">${skin.name}</div>`;
            const reqLabel = isLocked ? `<div class="skin-req">SCORE ${skin.req}</div>` : '';
            
            item.innerHTML = `${nameLabel}${preview}${reqLabel}`;
            if (!isLocked) {
                item.onclick = () => {
                    this.selectedSkin = skin;
                    this.renderSkinMenu();
                };
            }
            grid.appendChild(item);
        });
    }

    reset() {
        this.state = 'MENU';
        this.score = 0;
        this.cameraY = 0;
        this.ball = { x: 160, y: 100, vx: 0, vy: 0, onGround: false, currentPlatform: null };
        this.platforms = [];
        this.particles = [];
        this.nextY = 200;
        this.bonusCounter = 0;

        this.platforms.push({ 
            x: 110, y: 180, w: 100, h: 16, 
            type: PLATFORM_TYPES.NORMAL, landed: true, 
            vanishTimer: 90, isActivated: false, opacity: 1 
        });
        for(let i=1; i<8; i++) this.genPlat(200 + i * 80);
    }

    initParallax() {
        this.clouds = Array.from({length: 5}, () => ({
            x: Math.random() * 320, y: Math.random() * 448, s: 0.2 + Math.random() * 0.3
        }));
    }

    start() {
        this.reset();
        this.state = 'PLAYING';
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('skin-screen').classList.add('hidden');
        this.audio.jump();
        this.audio.playMusic('game');
    }

    genPlat(y) {
        const w = 64 + Math.random() * 32;
        const x = Math.random() * (320-w);
        let type = PLATFORM_TYPES.NORMAL;
        const rand = Math.random();
        if (rand > 0.88) type = PLATFORM_TYPES.BONUS;
        else if (rand > 0.75) type = PLATFORM_TYPES.VANISHING;

        this.platforms.push({ 
            x, y, w, h: 16, type, landed: false, vanishTimer: 100, isActivated: false, opacity: 1
        });
        this.nextY = y + 80 + Math.random() * 40;
    }

    spawnParticle(x, y, color) {
        for(let i=0; i<3; i++) {
            this.particles.push({
                x, y, vx: (Math.random() - 0.5) * 4, vy: (Math.random() - 0.5) * 4, 
                life: 15 + Math.random() * 10, color
            });
        }
    }

    update() {
        if (this.state !== 'PLAYING') return;
        const lv = this.getLevel();
        this.cameraY += lv.speed;

        const acc = this.ball.onGround ? 0.4 : 0.25;
        const fric = this.ball.onGround ? 0.85 : 0.96;
        if (this.input.left) this.ball.vx -= acc;
        if (this.input.right) this.ball.vx += acc;
        this.ball.vx *= fric;
        this.ball.vx = Math.min(MAX_VX, Math.max(-MAX_VX, this.ball.vx));
        this.ball.x += this.ball.vx;

        if (this.ball.x < 10) { this.ball.x = 10; this.ball.vx *= -0.5; }
        if (this.ball.x > 310) { this.ball.x = 310; this.ball.vx *= -0.5; }

        this.ball.vy += GRAVITY;
        this.ball.y += this.ball.vy;

        let foundGround = false;
        let pRef = null;

        if (this.ball.vy >= 0) {
            for (let p of this.platforms) {
                if (p.opacity <= 0) continue;
                if (this.ball.x + 8 > p.x && this.ball.x - 8 < p.x + p.w) {
                    if (this.ball.y + 10 >= p.y && this.ball.y + 10 <= p.y + 16 + this.ball.vy) {
                        this.ball.y = p.y - 10;
                        this.ball.vy = 0;
                        foundGround = true;
                        pRef = p;
                        if (!p.landed) { 
                            p.landed = true; 
                            this.score += 100; 
                            this.audio.land();
                            this.spawnParticle(this.ball.x, this.ball.y, lv.grass);
                            if (p.type === PLATFORM_TYPES.VANISHING) p.isActivated = true;
                        }
                        break;
                    }
                }
            }
        }
        
        this.ball.onGround = foundGround;
        this.ball.currentPlatform = pRef;

        if (this.ball.onGround && this.ball.currentPlatform?.type === PLATFORM_TYPES.BONUS) {
            this.bonusCounter++;
            if (this.bonusCounter % 10 === 0) {
                this.score += 20;
                this.audio.bonus();
                this.spawnParticle(this.ball.x, this.ball.y, '#fbf236');
            }
        } else {
            this.bonusCounter = 0;
        }

        this.platforms.forEach(p => {
            if (p.isActivated && p.type === PLATFORM_TYPES.VANISHING) {
                p.vanishTimer--;
                if (p.vanishTimer < 40) p.opacity = (Math.floor(p.vanishTimer / 4) % 2 === 0) ? 0.3 : 0.8;
                if (p.vanishTimer <= 0) {
                    p.opacity = 0;
                    if (this.ball.currentPlatform === p) {
                        this.ball.onGround = false;
                        this.ball.currentPlatform = null;
                    }
                }
            }
        });

        this.particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life--;
            if (p.life <= 0) this.particles.splice(i, 1);
        });

        const ry = this.ball.y - this.cameraY;
        if (ry > 432 || ry < 16) {
            this.state = 'GAMEOVER';
            this.audio.stopAllMusic(); 
            if (this.score > this.highScore) {
                this.highScore = this.score;
                document.getElementById('highScoreLabel').innerText = `BEST: ${Math.floor(this.highScore)}`;
            }
            this.audio.die();
            document.getElementById('finalScore').innerText = Math.floor(this.score);
            document.getElementById('game-over-screen').classList.remove('hidden');
        }

        while (this.nextY < this.cameraY + 550) this.genPlat(this.nextY);
        this.platforms = this.platforms.filter(p => p.y > this.cameraY - 100);

        document.getElementById('scoreVal').innerText = Math.floor(this.score).toString().padStart(6, '0');
        
        let currentLevel = 1;
        if (this.score >= LEVELS[2].threshold) currentLevel = 3;
        else if (this.score >= LEVELS[1].threshold) currentLevel = 2;
        document.getElementById('levelVal').innerText = `1-${currentLevel}`;
    }

    getLevel() {
        for(let i=LEVELS.length-1; i>=0; i--) if(this.score >= LEVELS[i].threshold) return LEVELS[i];
        return LEVELS[0];
    }

    draw() {
        const lv = this.getLevel();
        this.ctx.fillStyle = lv.sky;
        this.ctx.fillRect(0, 0, 320, 448);

        this.ctx.fillStyle = "rgba(255,255,255,0.3)";
        this.clouds.forEach(c => {
            let dy = (c.y - this.cameraY * c.s) % 448;
            if (dy < 0) dy += 448;
            this.ctx.fillRect(c.x, dy, 32, 12);
        });

        this.ctx.save();
        this.ctx.translate(0, -this.cameraY);

        for (let p of this.platforms) {
            if (p.opacity <= 0) continue;
            this.ctx.globalAlpha = p.opacity;
            let mainCol = lv.plat, topCol = lv.grass;
            if (p.type === PLATFORM_TYPES.BONUS) { mainCol = '#fbf236'; topCol = '#ffffff'; }
            else if (p.type === PLATFORM_TYPES.VANISHING) { mainCol = '#3f3f74'; topCol = '#5fcde4'; }

            this.ctx.fillStyle = mainCol;
            this.ctx.fillRect(p.x, p.y + 4, p.w, p.h - 4);
            this.ctx.fillStyle = topCol;
            this.ctx.fillRect(p.x, p.y, p.w, 6);
            this.ctx.fillStyle = "rgba(0,0,0,0.15)";
            for(let i=0; i<p.w; i+=8) this.ctx.fillRect(p.x + i, p.y + 6, 4, 2);
            this.ctx.strokeStyle = "#000";
            this.ctx.lineWidth = 2;
            this.ctx.strokeRect(p.x, p.y, p.w, p.h);
        }

        this.particles.forEach(p => {
            this.ctx.fillStyle = p.color;
            this.ctx.fillRect(p.x, p.y, 4, 4);
        });

        const {x, y} = this.ball;
        const s = this.selectedSkin;
        this.ctx.fillStyle = s.color; 
        this.ctx.fillRect(x-10, y-10, 20, 20);
        this.ctx.fillStyle = s.eye; 
        this.ctx.fillRect(x-4, y-4, 2, 4);
        this.ctx.fillRect(x+2, y-4, 2, 4);
        if (s.id !== 'void') {
            this.ctx.fillStyle = "rgba(255,255,255,0.4)"; 
            this.ctx.fillRect(x-7, y-7, 4, 4);
        }
        this.ctx.strokeStyle = "#000";
        this.ctx.lineWidth = 2;
        this.ctx.strokeRect(x-10, y-10, 20, 20);

        this.ctx.restore();
        this.ctx.globalAlpha = 1.0;

        this.ctx.fillStyle = "#333";
        for(let i=0; i<320; i+=16) {
            this.ctx.beginPath(); this.ctx.moveTo(i, 0); this.ctx.lineTo(i+8, 16); this.ctx.lineTo(i+16, 0); this.ctx.fill();
            this.ctx.beginPath(); this.ctx.moveTo(i, 448); this.ctx.lineTo(i+8, 432); this.ctx.lineTo(i+16, 448); this.ctx.fill();
        }
    }

    loop() {
        this.update();
        this.draw();
        requestAnimationFrame(() => this.loop());
    }
}

// Сообщаем Telegram, что приложение готово
if (window.Telegram && window.Telegram.WebApp) {
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand();
}

window.onload = () => new Game();
</script>
</body>
</html>